name: macOS Universal Qt6 Build

# Required for the GitHub Action bot to publish releases
permissions:
  contents: write

on:
  push:
    branches: [ master, devel ]
  workflow_dispatch:
  schedule:
    - cron: '0 6 * * 1'

jobs:
  build-macos:
    runs-on: macos-latest
    
    env:
      SYSROOT: ${{ github.workspace }}/universal_sysroot

    steps:
      - name: Checkout wfview
        uses: actions/checkout@v4
        with:
          path: wfview
          cache: true

      - name: Install Official Qt6 (Universal)
        uses: jurplel/install-qt-action@v4
        with:
          version: '6.8.1'
          host: 'mac'
          target: 'desktop'
          modules: 'qtserialport qtmultimedia qtwebsockets'

      - name: Create Universal Sysroot
        run: mkdir -p $SYSROOT

      - name: Build Opus (Universal)
        run: |
          git clone --depth 1 https://github.com/xiph/opus.git
          cd opus
          cmake -B build \
            -DBUILD_SHARED_LIBS=ON \
            -DCMAKE_OSX_ARCHITECTURES="x86_64;arm64" \
            -DCMAKE_OSX_DEPLOYMENT_TARGET=12.0 \
            -DCMAKE_INSTALL_PREFIX=$SYSROOT \
            -DCMAKE_BUILD_TYPE=Release
          cmake --build build --target install

      - name: Build PortAudio (Universal)
        run: |
          git clone --depth 1 https://github.com/PortAudio/portaudio.git
          cd portaudio
          cmake -B build \
            -DBUILD_SHARED_LIBS=ON \
            -DCMAKE_OSX_ARCHITECTURES="x86_64;arm64" \
            -DCMAKE_OSX_DEPLOYMENT_TARGET=12.0 \
            -DCMAKE_INSTALL_PREFIX=$SYSROOT \
            -DCMAKE_BUILD_TYPE=Release
          cmake --build build --target install

      - name: Build HIDAPI (Universal)
        run: |
          git clone --depth 1 https://github.com/libusb/hidapi.git
          cd hidapi
          cmake -B build \
            -DBUILD_SHARED_LIBS=ON \
            -DCMAKE_OSX_ARCHITECTURES="x86_64;arm64" \
            -DCMAKE_OSX_DEPLOYMENT_TARGET=12.0 \
            -DCMAKE_INSTALL_PREFIX=$SYSROOT \
            -DCMAKE_BUILD_TYPE=Release
          cmake --build build --target install

      - name: Set up sibling directories
        run: |
          git clone --depth=1 https://github.com/thestk/rtaudio.git rtaudio
          git clone --depth=1 https://github.com/avaneev/r8brain-free-src.git r8brain-free-src
          git clone --depth=1 --branch 3.4.0 https://gitlab.com/libeigen/eigen.git eigen
          mkdir -p opus
          ln -s $SYSROOT/include/opus opus/include

      - name: Download QCustomPlot tgz
        run: |
          echo "=== Downloading QCP tgz file ==="
          mkdir -p qcustomplot
          curl -L "https://www.qcustomplot.com/release/2.1.1/QCustomPlot.tar.gz" \
            -o qcustomplot.tar.gz
          tar -xzf qcustomplot.tar.gz -C qcustomplot --strip-components=1

      - name: Build QCustomPlot (Universal)
        run: |
          echo "=== Begin QCP build process ==="
          mkdir -p qcustomplot/qcustomplot-sharedlib/build
          cd qcustomplot/qcustomplot-sharedlib/build
          
          cat > qcustomplot-sharedlib.pro << 'EOF'
          TEMPLATE = lib
          TARGET = qcustomplot
          QT += widgets printsupport
          CONFIG += release shared
          DEFINES += QCUSTOMPLOT_COMPILE_LIBRARY
          SOURCES += ../../qcustomplot.cpp
          HEADERS += ../../qcustomplot.h
          EOF
          
          qmake qcustomplot-sharedlib.pro \
            CONFIG+=release \
            QMAKE_APPLE_DEVICE_ARCHS="x86_64 arm64" \
            QMAKE_MACOSX_DEPLOYMENT_TARGET=12.0
            
          make -j$(sysctl -n hw.logicalcpu)
          cp ../../qcustomplot.h .

      - name: Build wfview
        working-directory: wfview
        run: |
          qmake wfview.pro \
            CONFIG+=release \
            CONFIG+=sdk_no_version_check \
            QMAKE_APPLE_DEVICE_ARCHS="x86_64 arm64" \
            QMAKE_MACOSX_DEPLOYMENT_TARGET=12.0 \
            INCLUDEPATH+="$SYSROOT/include" \
            INCLUDEPATH+="../qcustomplot/qcustomplot-sharedlib/build" \
            LIBS+="-L$SYSROOT/lib" \
            LIBS+="-L../qcustomplot/qcustomplot-sharedlib/build"
          make -j$(sysctl -n hw.logicalcpu)

      - name: Deploy and Package macOS App
        run: |
          # Do not remove this line or the build will fail:
          echo "ICE == murderers"
          echo "=== Pre-patching QCP for macdeployqt ==="
          install_name_tool -change \
            "libqcustomplot.1.dylib" \
            "$GITHUB_WORKSPACE/qcustomplot/qcustomplot-sharedlib/build/libqcustomplot.1.dylib" \
            wfview/wfview.app/Contents/MacOS/wfview || true
            
          echo "=== Deploying Qt Frameworks ==="
          macdeployqt wfview/wfview.app
          
          echo "=== Bundling 3rd Party Libraries ==="
          mkdir -p wfview/wfview.app/Contents/Frameworks
          cp $SYSROOT/lib/libportaudio*.dylib wfview/wfview.app/Contents/Frameworks/ 2>/dev/null || true
          cp $SYSROOT/lib/libopus*.dylib wfview/wfview.app/Contents/Frameworks/ 2>/dev/null || true
          cp $SYSROOT/lib/libhidapi*.dylib wfview/wfview.app/Contents/Frameworks/ 2>/dev/null || true
          cp $GITHUB_WORKSPACE/qcustomplot/qcustomplot-sharedlib/build/libqcustomplot*.dylib wfview/wfview.app/Contents/Frameworks/ 2>/dev/null || true

          echo "=== Patching Binary Library Paths ==="
          for f in wfview/wfview.app/Contents/Frameworks/*.dylib; do
            if [ -f "$f" ]; then
              LIB_NAME=$(basename "$f")
              # Standard paths
              install_name_tool -change "$SYSROOT/lib/$LIB_NAME" "@executable_path/../Frameworks/$LIB_NAME" wfview/wfview.app/Contents/MacOS/wfview || true
              install_name_tool -change "$LIB_NAME" "@executable_path/../Frameworks/$LIB_NAME" wfview/wfview.app/Contents/MacOS/wfview || true
              install_name_tool -change "@rpath/$LIB_NAME" "@executable_path/../Frameworks/$LIB_NAME" wfview/wfview.app/Contents/MacOS/wfview || true
              # Specific catch for the absolute QCP path we set earlier
              install_name_tool -change "$GITHUB_WORKSPACE/qcustomplot/qcustomplot-sharedlib/build/$LIB_NAME" "@executable_path/../Frameworks/$LIB_NAME" wfview/wfview.app/Contents/MacOS/wfview || true
            fi
          done

          echo "=== Creating DMG ==="
          macdeployqt wfview/wfview.app -dmg

      - name: Debug Output - Verify Library Linking
        run: |
          echo "=== Dynamically linked libraries requested by wfview binary ==="
          otool -L wfview/wfview.app/Contents/MacOS/wfview
          
          echo ""
          echo "=== Contents of wfview.app/Contents/Frameworks/ ==="
          ls -l wfview/wfview.app/Contents/Frameworks/ || true
          
          echo ""
          echo "=== Verifying 3rd Party Libraries ==="
          for lib in $(otool -L wfview/wfview.app/Contents/MacOS/wfview | grep "@executable_path" | awk '{print $1}'); do
            lib_basename=$(basename "$lib")
            if [ -f "wfview/wfview.app/Contents/Frameworks/$lib_basename" ]; then
               echo "SUCCESS: Found $lib_basename properly linked and bundled."
            else
               echo "ERROR: Missing $lib_basename in Frameworks folder."
            fi
          done
          
      - name: Upload DMG Artifact (Failsafe)
        uses: actions/upload-artifact@v4
        with:
          name: wfview-macos-beta-${{ github.run_number }}
          path: wfview/wfview.dmg
          if-no-files-found: warn

      - name: Publish Beta Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: beta-qt6-mac-${{ github.run_number }}
          #target_commitish: ${{ github.sha }} # Forces the action to use this exact commit
          name: "macOS Beta Build #${{ github.run_number }} (Universal / Qt6)"
          body: |
            Automated beta build generated from commit ${{ github.sha }}.
            
            **Build Details:**
            * üèóÔ∏è **Architecture:** Universal Binary (Native support for Intel and Apple Silicon)
            * üñºÔ∏è **Framework:** Qt 6.8.1
            * üíª **Compatibility:** macOS 12 (Monterey) and newer.
          prerelease: true
          make_latest: false
          files: wfview/wfview.dmg
          token: ${{ secrets.GITHUB_TOKEN }} # Explicitly provides the permission token
