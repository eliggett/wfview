stages:
  - deploy
  
variables:
  # Branches to mirror to GitHub. Edit this list as needed.
  MIRROR_BRANCHES: "master newscope"

mirror-to-github:
  stage: deploy
  variables:
    GIT_DEPTH: "1"
  rules:
    - if: $CI_COMMIT_BRANCH
  image: 
    name: alpine/git:latest
    entrypoint: [""]
  script:
    - |
      # Check if current branch is in the mirror list
      SHOULD_MIRROR=false
      for BRANCH in $MIRROR_BRANCHES; do
        if [ "$CI_COMMIT_BRANCH" = "$BRANCH" ]; then
          SHOULD_MIRROR=true
          break
        fi
      done

      if [ "$SHOULD_MIRROR" = "false" ]; then
        echo "Branch '$CI_COMMIT_BRANCH' is not in mirror list, skipping."
        exit 0
      fi

      echo "Mirroring branch '$CI_COMMIT_BRANCH' to GitHub..."

      # Set up git identity (required for some git operations)
      git config user.email "ci@mirror"
      git config user.name "GitLab Mirror"

      # Fetch just the current branch at depth 1 from origin
      #git fetch --depth=1 origin $CI_COMMIT_BRANCH
      git checkout --orphan mirror_branch
      git add -A
      git commit -m "Mirror of $CI_COMMIT_SHORT_SHA"

      # Force push to GitHub
      git push --force --no-thin \
        "https://x-access-token:${GITHUB_PAT}@github.com/eliggett/wfview.git" \
        "HEAD:refs/heads/$CI_COMMIT_BRANCH"

      echo "Done."